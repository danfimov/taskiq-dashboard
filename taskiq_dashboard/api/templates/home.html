<!DOCTYPE html>
<html lang="en">
<head>
    <title>Taskiq Dashboard</title>
    <meta name="description" content="Main page of Taskiq Dashboard">
    <meta name="keywords" content="python, taskiq, tasks">
    {% include "partial/head.html" %}
</head>
<body class="bg-ctp-base"
    hx-on:keydown='{% include "scripts/focus_on_search_field.js" %}'>
    {% include "partial/header.html" %}
    <main class="container mx-auto pb-8">
    <section class="mb-6 p-5">
        <div id="filter-form" class="flex flex-col md:flex-row gap-4 items-end">
            <!-- Left side: Search and Status filters -->
            <div class="flex flex-col md:flex-row gap-4 flex-1">
                <!-- Name Search -->
                <div class="relative group text-ctp-subtext0 hover:text-ctp-subtext1 focus:text-ctp-subtext1 md:w-auto min-w-[200px]">
                    <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none">
                        <use href="{{ url_for('static', path='icons.svg#search') }}"></use>
                    </svg>
                    <input
                        type="text"
                        name="q"
                        id="search"
                        class=" w-full pl-12 pr-4 py-2 border rounded focus:outline-none focus:ring-2 transition-all duration-200 hover:shadow-md border-ctp-subtext0 group-hover:border-ctp-subtext1 "
                        placeholder="Search by id or name"
                        value="{{ q if q is defined else '' }}"
                        hx-get="{{ url_for('Task list view') }}"
                        hx-trigger="keyup changed delay:500ms"
                        hx-target="#task-list"
                        hx-push-url="true"
                        hx-include="[name='status']"
                    >
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-6 p-2 pt-1 rounded-sm bg-ctp-lavender/10 text-sm"
                         title="Фокус на поисковой строке">/</div>
                </div>

                <!-- Status Filter -->
                <div class="text-ctp-subtext0 hover:text-ctp-subtext1 focus:text-ctp-subtext1 md:w-auto min-w-[150px]">
                    <div class="relative">
                    <select
                        id="status"
                        name="status"
                        class=" w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 transition-all duration-200 hover:shadow-md border-ctp-subtext0 group-hover:border-ctp-subtext1 appearance-none"
                        hx-get="{{ url_for('Task list view') }}"
                        hx-trigger="change"
                        hx-target="#task-list-body"
                        hx-push-url="true"
                        hx-include="[name='search']"
                    >
                        {% set status = status if status is defined else "all" %}
                        <option class="bg-ctp-base" value="null" {% if status == "null" %}selected{% endif %}>All Statuses</option>
                        <option class="bg-ctp-base" value="0" {% if status == "0" %}selected{% endif %}>In Progress</option>
                        <option class="bg-ctp-base" value="1" {% if status == "1" %}selected{% endif %}>Completed</option>
                        <option class="bg-ctp-base" value="2" {% if status == "2" %}selected{% endif %}>Failure</option>
                        <option class="bg-ctp-base" value="3" {% if status == "3" %}selected{% endif %}>Queued</option>
                    </select>
                    <svg id="status-chevron"
                         class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-ctp-mauve-100 transform transition-transform duration-200"
                         aria-hidden="true">
                        <use href="{{ url_for('static', path='icons.svg#chevron-left') }}"></use>
                    </svg>
                    <script>
                    const selectEl = document.getElementById("status");
                    const chevronEl = document.getElementById("status-chevron");
                    const openChevron = () => {
                        chevronEl && chevronEl.classList.add("-rotate-90");
                        selectEl.setAttribute("aria-expanded", "true");
                    };
                    const closeChevron = () => {
                        chevronEl && chevronEl.classList.remove("-rotate-90");
                        selectEl.setAttribute("aria-expanded", "false");
                    };

                    // opening cases
                    selectEl.addEventListener("pointerdown", openChevron);
                    selectEl.addEventListener("click", openChevron);
                    selectEl.addEventListener("keydown", (e) => {
                        if (["ArrowUp", "ArrowDown", " ", "Enter"].includes(e.key)) openChevron();
                    });
                    // closing cases
                    selectEl.addEventListener("blur", closeChevron);
                    selectEl.addEventListener("change", closeChevron);
                    selectEl.addEventListener("keyup", (e) => {
                        if (e.key === "Escape") closeChevron();
                    });
                    document.addEventListener("pointerdown", (e) => {
                        if (!selectEl.contains(e.target)) {
                            closeChevron();
                        }
                    });
                    </script>
                    </div>
                </div>
            </div>

            <!-- Right side: Bulk actions -->
            <div class="relative" id="bulk-actions-container">
                <div class="flex items-center gap-3">
                    <span id="selected-count" class="text-sm text-ctp-subtext0 whitespace-nowrap">0 selected</span>
                    <div class="relative">
                        <select
                            id="bulk-action-select"
                            class="px-4 py-2 border rounded focus:outline-none focus:ring-2 transition-all duration-200 hover:shadow-md border-ctp-subtext0 bg-ctp-base text-ctp-text appearance-none pr-8 min-w-[150px]"
                        >
                            <option value="">Select action</option>
                            <option value="rerun">Rerun tasks</option>
                            <option value="delete">Delete tasks</option>
                        </select>
                        <svg class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-ctp-mauve-100"
                             aria-hidden="true">
                            <use href="{{ url_for('static', path='icons.svg#chevron-left') }}"></use>
                        </svg>
                    </div>
                    <button
                        id="apply-bulk-action"
                        class="px-4 py-2 bg-ctp-blue text-ctp-base rounded hover:bg-ctp-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
                        disabled
                    >
                        Apply
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Task table section -->
    <section class="overflow-x-auto mb-6 p-5">
        <table id="task-list" class="min-w-full divide-y divide-ctp-blue/20 table-auto">
            <thead>
                <tr class="sticky top-0">
                    <th scope="col" class="px-6 py-3 text-left font-normal text-ctp-text tracking-wider w-min">
                        <input
                            type="checkbox"
                            id="select-all-checkbox"
                            class="w-4 h-4 text-ctp-blue bg-ctp-base border-ctp-subtext0 rounded focus:ring-ctp-blue focus:ring-2"
                            title="Select all tasks"
                        >
                    </th>
                    <th scope="col" class="px-6 py-3 text-left font-normal text-ctp-text tracking-wider">Task ID</th>
                    <th scope="col" class="px-6 py-3 text-left font-normal text-ctp-text tracking-wider">Name</th>
                    <th scope="col" class="px-6 py-3 text-left font-normal text-ctp-text tracking-wider">Status</th>
                    <th scope="col" class="px-6 py-3 text-left font-normal text-ctp-text tracking-wider">Worker</th>
                    <th scope="col" class="px-6 py-3 text-left font-normal text-ctp-text tracking-wider">
                        <a href="{{ url_for('Task list view') }}?status={{ status }}&q={{ q }}&sort_by=started_at&sort_order={%- if sort_by == 'started_at' and sort_order == 'asc' -%}desc{%- else -%}asc{%- endif -%}"
                           class="flex items-center gap-2 hover:text-ctp-subtext0 transition-colors">
                            Started At
                            <span class="inline-flex">
                            {% if sort_by == 'started_at' %}
                                {% if sort_order == 'asc' %}
                                    <svg class="w-4 h-4 rotate-90"><use href="{{ url_for('static', path='icons.svg#chevron-left') }}"></use></svg>
                                {% else %}
                                    <svg class="w-4 h-4 -rotate-90"><use href="{{ url_for('static', path='icons.svg#chevron-left') }}"></use></svg>
                                {% endif %}
                            {% else %}
                                <svg class="w-4 h-4"><use href="{{ url_for('static', path='icons.svg#arrow-up-down') }}"></use></svg>
                            {% endif %}
                            </span>
                        </a>
                    </th>
                    <th scope="col" class="px-6 py-3 text-left font-normal text-ctp-text tracking-wider">
                        <a href="{{ url_for('Task list view') }}?status={{ status }}&q={{ q }}&sort_by=finished_at&sort_order={%- if sort_by == 'finished_at' and sort_order == 'asc' -%}desc{%- else -%}asc{%- endif -%}"
                           class="flex items-center gap-2 hover:text-ctp-subtext0 transition-colors">
                            Finished At
                            <span class="inline-flex">
                            {% if sort_by == 'finished_at' %}
                                {% if sort_order == 'asc' %}
                                    <svg class="w-4 h-4 rotate-90"><use href="{{ url_for('static', path='icons.svg#chevron-left') }}"></use></svg>
                                {% else %}
                                    <svg class="w-4 h-4 -rotate-90"><use href="{{ url_for('static', path='icons.svg#chevron-left') }}"></use></svg>
                                {% endif %}
                            {% else %}
                                <svg class="w-4 h-4"><use href="{{ url_for('static', path='icons.svg#arrow-up-down') }}"></use></svg>
                            {% endif %}
                            </span>
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody id="task-list-body" class="divide-y text-ctp-text divide-ctp-blue/20">
                {% include "partial/task_list.html" with context %}
            </tbody>
        </table>
    </section>
    </main>

    <!-- Notification container -->
    <div id="notification-list" class="fixed bottom-6 right-6 flex flex-col gap-3 w-fit"></div>

    <script>
        // Bulk actions management
        (function() {
            const selectedTasks = new Set();
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const applyButton = document.getElementById('apply-bulk-action');
            const bulkActionSelect = document.getElementById('bulk-action-select');
            const selectedCountSpan = document.getElementById('selected-count');

            function updateUI() {
                const count = selectedTasks.size;
                selectedCountSpan.textContent = `${count} selected`;
                applyButton.disabled = count === 0 || !bulkActionSelect.value;

                // Update select all checkbox state
                const allCheckboxes = document.querySelectorAll('.task-checkbox');
                if (allCheckboxes.length > 0) {
                    const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
                    selectAllCheckbox.checked = checkedCount === allCheckboxes.length && count > 0;
                    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }
            }

            function handleCheckboxChange(checkbox) {
                const taskId = checkbox.value;
                if (checkbox.checked) {
                    selectedTasks.add(taskId);
                } else {
                    selectedTasks.delete(taskId);
                }
                updateUI();
            }

            // Handle individual task checkboxes
            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('task-checkbox')) {
                    handleCheckboxChange(e.target);
                }
            });

            // Handle select all checkbox
            selectAllCheckbox.addEventListener('change', (e) => {
                const allCheckboxes = document.querySelectorAll('.task-checkbox');
                allCheckboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                    const taskId = checkbox.value;
                    if (e.target.checked) {
                        selectedTasks.add(taskId);
                    } else {
                        selectedTasks.delete(taskId);
                    }
                });
                updateUI();
            });

            // Handle bulk action select change
            bulkActionSelect.addEventListener('change', () => {
                updateUI();
            });

            // Handle apply button click
            applyButton.addEventListener('click', () => {
                const action = bulkActionSelect.value;
                if (!action || selectedTasks.size === 0) {
                    return;
                }

                const taskIds = Array.from(selectedTasks);
                const url = action === 'rerun' 
                    ? '{{ url_for("Bulk rerun tasks") }}'
                    : '{{ url_for("Bulk delete tasks") }}';

                // Disable button during request
                applyButton.disabled = true;
                applyButton.textContent = 'Processing...';

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'HX-Request': 'true'
                    },
                    body: JSON.stringify({ task_ids: taskIds })
                })
                .then(response => {
                    if (action === 'delete') {
                        // For delete, reload the page to refresh the task list
                        window.location.reload();
                        return;
                    } else {
                        // For rerun, show notification
                        return response.text();
                    }
                })
                .then(html => {
                    if (html) {
                        // Add notification to notification container
                        const notificationContainer = document.getElementById('notification-list');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        notificationContainer.appendChild(tempDiv.firstElementChild);
                    }
                    // Clear selection and reset UI
                    selectedTasks.clear();
                    bulkActionSelect.value = '';
                    document.querySelectorAll('.task-checkbox').forEach(cb => cb.checked = false);
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                    applyButton.textContent = 'Apply';
                    updateUI();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while processing the request');
                    applyButton.disabled = false;
                    applyButton.textContent = 'Apply';
                });
            });

            // Update UI when new tasks are loaded via HTMX
            document.body.addEventListener('htmx:afterSwap', (e) => {
                if (e.detail.target.id === 'task-list-body') {
                    // Remove task IDs from selection if their checkboxes no longer exist
                    const currentCheckboxes = Array.from(document.querySelectorAll('.task-checkbox'));
                    const currentTaskIds = new Set(currentCheckboxes.map(cb => cb.value));
                    const tasksToRemove = Array.from(selectedTasks).filter(id => !currentTaskIds.has(id));
                    tasksToRemove.forEach(id => selectedTasks.delete(id));
                    // Always update UI to reflect current state
                    updateUI();
                }
            });

            // Initial UI update
            updateUI();
        })();
    </script>
</body>
</html>
