<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taskiq Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <style>
        /* Custom Select Styling */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* Input and button consistent styling */
        .form-input {
            height: 38px;
            padding: 0 12px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
        }

        .form-input:focus {
            outline: none;
            border-color: rgb(178.5, 0, 28.56);
            box-shadow: 0 0 0 2px rgba(178.5, 0, 28.56, 0.2);
        }

    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8 text-gray-800">Taskiq Dashboard</h1>

        <div>
            <!-- Filter Section -->
            <div class="mb-6 bg-white p-5 rounded-lg shadow">
                <div id="filter-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Name Search -->
                    <div class="col-span-2">
                        <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search by name</label>
                        <div class="mt-1">
                            <input
                                type="text"
                                name="search"
                                id="search"
                                class="form-input w-full"
                                placeholder="Enter task name..."
                                value="{{ filters.search }}"
                                hx-get="/dashboard"
                                hx-trigger="keyup changed delay:500ms"
                                hx-target="body"
                                hx-push-url="true"
                                hx-include="[name='status']"
                            >
                        </div>
                    </div>

                    <!-- Status Filter -->
                    <div class="col-span-1">
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select
                            id="status"
                            name="status"
                            class="custom-select form-input w-full"
                            hx-get="/dashboard"
                            hx-trigger="change"
                            hx-target="body"
                            hx-push-url="true"
                            hx-include="[name='search']"
                        >
                            <option value="all" {% if filters.status == "all" %}selected{% endif %}>All Statuses</option>
                            <option value="in progress" {% if filters.status == "in progress" %}selected{% endif %}>In Progress</option>
                            <option value="completed" {% if filters.status == "completed" %}selected{% endif %}>Completed</option>
                            <option value="failure" {% if filters.status == "failure" %}selected{% endif %}>Failure</option>
                            <option value="abandoned" {% if filters.status == "abandoned" %}selected{% endif %}>Abandoned</option>
                        </select>
                    </div>


                </div>
            </div>

            <!-- Tasks Table -->
            <div class="overflow-x-auto bg-white rounded-lg shadow">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            {% set headers = ['Task ID', 'Name', 'Status', 'Worker', 'Started At', 'Finished At'] %}
                            {% for header in headers %}
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ header }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% if tasks %}
                            {% for task in tasks %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <a href="/dashboard/tasks/{{ task.id }}" class="text-primary hover:text-primary-hover">{{ task.id }}</a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ task.name }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span
                                        class="px-2 inline-flex text-sm leading-5 rounded
                                            {% if task.status == 0 %}bg-yellow-100 text-yellow-800
                                            {% elif task.status == 1 %}bg-green-100 text-green-800
                                            {% elif task.status == 2 %}bg-red-100 text-red-800
                                            {% elif task.status == 3 %}bg-gray-100 text-gray-800{% endif %}"
                                    >
                                        {% if task.status == 0 %}In progress
                                        {% elif task.status == 1 %}Completed
                                        {% elif task.status == 2 %}Failure
                                        {% elif task.status == 3 %}Abandoned
                                        {% else %}Unknown{% endif %}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ task.worker }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ task.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ task.finished_at.strftime('%Y-%m-%d %H:%M:%S') if task.finished_at else '-' }}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-sm text-center text-gray-500">No tasks found</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if pagination.total_pages > 1 %}
            <div class="mt-6 flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    Showing <span class="font-medium">{{ (pagination.page - 1) * pagination.per_page + 1 }}</span> to
                    <span class="font-medium">
                        {{ [pagination.page * pagination.per_page, pagination.total_count] | min }}
                    </span> of
                    <span class="font-medium">{{ pagination.total_count }}</span> tasks
                </div>

                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <!-- Previous page -->
                        {% if pagination.has_prev %}
                            <a href="?page={{ pagination.page - 1 }}{% for k, v in pagination.filter_params.items() %}&{{ k }}={{ v }}{% endfor %}"
                               class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                               aria-label="Previous">
                                <span class="sr-only">Previous</span>
                                <img src="/static/icons/chevron-left.svg" alt="Previous" class="h-4 w-4">
                            </a>
                        {% else %}
                            <span class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed"
                                 aria-label="Previous disabled">
                                <span class="sr-only">Previous</span>
                                <img src="/static/icons/chevron-left.svg" alt="Previous" class="h-4 w-4">
                            </span>
                        {% endif %}

                        <!-- Page numbers -->
                        {% for page_num in pagination.visible_pages %}
                            {% if page_num == -1 %}
                                <!-- Ellipsis -->
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                    ...
                                </span>
                            {% else %}
                                <!-- Page number -->
                                <a href="?page={{ page_num }}{% for k, v in pagination.filter_params.items() %}&{{ k }}={{ v }}{% endfor %}"
                                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 {% if page_num == pagination.page %}bg-primary bg-opacity-10 text-primary border-primary{% else %}bg-white text-gray-700 hover:bg-gray-50{% endif %} text-sm font-medium">
                                   {{ page_num }}
                                </a>
                            {% endif %}
                        {% endfor %}

                        <!-- Next page -->
                        {% if pagination.has_next %}
                            <a href="?page={{ pagination.page + 1 }}{% for k, v in pagination.filter_params.items() %}&{{ k }}={{ v }}{% endfor %}"
                               class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                               aria-label="Next">
                                <span class="sr-only">Next</span>
                                <img src="/static/icons/chevron-right.svg" alt="Next" class="h-4 w-4">
                            </a>
                        {% else %}
                            <span class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed"
                                aria-label="Next disabled">
                                <span class="sr-only">Next</span>
                                <img src="/static/icons/chevron-right.svg" alt="Next" class="h-4 w-4">
                            </span>
                        {% endif %}
                    </nav>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</body>
</html>
